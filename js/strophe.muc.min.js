(function(){var e,t,n,r=function(e,t){return function(){return e.apply(t,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:[],init:function(e){this._connection=e;this._muc_handler=null;Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner");Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin");Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user");return Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(e,t,r,i,s,o,u){var a,f,l,c,h,p=this;f=this.test_append_nick(e,t);a=$pres({from:this._connection.jid,to:f}).c("x",{xmlns:Strophe.NS.MUC});if(u!=null){a=a.c("history",u)}if(o!=null){a.cnode(Strophe.xmlElement("password",[],o))}if((c=this._muc_handler)==null){this._muc_handler=this._connection.addHandler(function(t){var n,r,i,s,o,u,a,f,l,c;n=t.getAttribute("from");if(!n){return true}o=n.split("/")[0];if(!p.rooms[o]){return true}e=p.rooms[o];i={};if(t.nodeName==="message"){i=e._message_handlers}else if(t.nodeName==="presence"){f=t.getElementsByTagName("x");if(f.length>0){for(l=0,c=f.length;l<c;l++){u=f[l];a=u.getAttribute("xmlns");if(a&&a.match(Strophe.NS.MUC)){i=e._presence_handlers;break}}}}for(s in i){r=i[s];if(!r(t,e)){delete i[s]}}return true})}if((h=(l=this.rooms)[e])==null){l[e]=new n(this,e,t,o)}if(i){this.rooms[e].addHandler("presence",i)}if(r){this.rooms[e].addHandler("message",r)}if(s){this.rooms[e].addHandler("roster",s)}return this._connection.send(a)},leave:function(e,t,n,r){var i,s,o;delete this.rooms[e];if(this.rooms.length===0){this._connection.deleteHandler(this._muc_handler);this._muc_handler=null}o=this.test_append_nick(e,t);s=this._connection.getUniqueId();i=$pres({type:"unavailable",id:s,from:this._connection.jid,to:o});if(r!=null){i.c("status",r)}if(n!=null){this._connection.addHandler(n,null,"presence",null,s)}this._connection.send(i);return s},message:function(e,t,n,r,i){var s,o,u,a;a=this.test_append_nick(e,t);i=i||(t!=null?"chat":"groupchat");o=this._connection.getUniqueId();s=$msg({to:a,from:this._connection.jid,type:i,id:o}).c("body",{xmlns:Strophe.NS.CLIENT}).t(n);s.up();if(r!=null){s.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).t(r);if(s.node.childNodes.length===0){u=s.node.parentNode;s.up().up();s.node.removeChild(u)}else{s.up().up()}}s.c("x",{xmlns:"jabber:x:event"}).c("composing");this._connection.send(s);return o},groupchat:function(e,t,n){return this.message(e,null,t,n)},invite:function(e,t,n){var r,i;i=this._connection.getUniqueId();r=$msg({from:this._connection.jid,to:e,id:i}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:t});if(n!=null){r.c("reason",n)}this._connection.send(r);return i},directInvite:function(e,t,n,r){var i,s,o;o=this._connection.getUniqueId();i={xmlns:"jabber:x:conference",jid:e};if(n!=null){i.reason=n}if(r!=null){i.password=r}s=$msg({from:this._connection.jid,to:t,id:o}).c("x",i);this._connection.send(s);return o},queryOccupants:function(e,t,n){var r,i;r={xmlns:Strophe.NS.DISCO_ITEMS};i=$iq({from:this._connection.jid,to:e,type:"get"}).c("query",r);return this._connection.sendIQ(i,t,n)},configure:function(e,t,n){var r,i;r=$iq({to:e,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});i=r.tree();return this._connection.sendIQ(i,t,n)},cancelConfigure:function(e){var t,n;t=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"});n=t.tree();return this._connection.sendIQ(n)},saveConfiguration:function(e,t,n,r){var i,s,o,u,a;s=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});s.c("x",{xmlns:"jabber:x:data",type:"submit"});for(u=0,a=t.length;u<a;u++){i=t[u];console.log(i);s.cnode(i).up()}o=s.tree();return this._connection.sendIQ(o,n,r)},createInstantRoom:function(e,t,n){var r;r=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(r.tree(),t,n)},setTopic:function(e,t){var n;n=$msg({to:e,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(t);return this._connection.send(n.tree())},_modifyPrivilege:function(e,t,n,r,i){var s;s=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(t.node);if(n!=null){s.c("reason",n)}return this._connection.sendIQ(s.tree(),r,i)},modifyRole:function(e,t,n,r,i,s){var o;o=$build("item",{nick:t,role:n});return this._modifyPrivilege(e,o,r,i,s)},kick:function(e,t,n,r,i){return this.modifyRole(e,t,"none",n,r,i)},voice:function(e,t,n,r,i){return this.modifyRole(e,t,"participant",n,r,i)},mute:function(e,t,n,r,i){return this.modifyRole(e,t,"visitor",n,r,i)},op:function(e,t,n,r,i){return this.modifyRole(e,t,"moderator",n,r,i)},deop:function(e,t,n,r,i){return this.modifyRole(e,t,"participant",n,r,i)},modifyAffiliation:function(e,t,n,r,i,s){var o;o=$build("item",{jid:t,affiliation:n});return this._modifyPrivilege(e,o,r,i,s)},ban:function(e,t,n,r,i){return this.modifyAffiliation(e,t,"outcast",n,r,i)},member:function(e,t,n,r,i){return this.modifyAffiliation(e,t,"member",n,r,i)},revoke:function(e,t,n,r,i){return this.modifyAffiliation(e,t,"none",n,r,i)},owner:function(e,t,n,r,i){return this.modifyAffiliation(e,t,"owner",n,r,i)},admin:function(e,t,n,r,i){return this.modifyAffiliation(e,t,"admin",n,r,i)},changeNick:function(e,t){var n,r;r=this.test_append_nick(e,t);n=$pres({from:this._connection.jid,to:r,id:this._connection.getUniqueId()});return this._connection.send(n.tree())},setStatus:function(e,t,n,r){var i,s;s=this.test_append_nick(e,t);i=$pres({from:this._connection.jid,to:s});if(n!=null){i.c("show",n).up()}if(r!=null){i.c("status",r)}return this._connection.send(i.tree())},listRooms:function(e,t,n){var r;r=$iq({to:e,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(r,t,n)},test_append_nick:function(e,t){return e+(t!=null?"/"+Strophe.escapeNode(t):"")}});n=function(){function t(e,t,n,i){this.client=e;this.name=t;this.nick=n;this.password=i;this._roomRosterHandler=r(this._roomRosterHandler,this);this._addOccupant=r(this._addOccupant,this);if(e.muc){this.client=e.muc}this.name=Strophe.getBareJidFromJid(t);this.client.rooms[this.name]=this;this.addHandler("presence",this._roomRosterHandler)}t.prototype.roster={};t.prototype._message_handlers={};t.prototype._presence_handlers={};t.prototype._roster_handlers={};t.prototype._handler_ids=0;t.prototype.join=function(e,t,n){return this.client.join(this.name,this.nick,e,t,n,this.password)};t.prototype.leave=function(e,t){this.client.leave(this.name,this.nick,e,t);return delete this.client.rooms[this.name]};t.prototype.message=function(e,t,n,r){return this.client.message(this.name,e,t,n,r)};t.prototype.groupchat=function(e,t){return this.client.groupchat(this.name,e,t)};t.prototype.invite=function(e,t){return this.client.invite(this.name,e,t)};t.prototype.directInvite=function(e,t){return this.client.directInvite(this.name,e,t,this.password)};t.prototype.configure=function(e){return this.client.configure(this.name,e)};t.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)};t.prototype.saveConfiguration=function(e){return this.client.saveConfiguration(this.name,e)};t.prototype.queryOccupants=function(e,t){return this.client.queryOccupants(this.name,e,t)};t.prototype.setTopic=function(e){return this.client.setTopic(this.name,e)};t.prototype.modifyRole=function(e,t,n,r,i){return this.client.modifyRole(this.name,e,t,n,r,i)};t.prototype.kick=function(e,t,n,r){return this.client.kick(this.name,e,t,n,r)};t.prototype.voice=function(e,t,n,r){return this.client.voice(this.name,e,t,n,r)};t.prototype.mute=function(e,t,n,r){return this.client.mute(this.name,e,t,n,r)};t.prototype.op=function(e,t,n,r){return this.client.op(this.name,e,t,n,r)};t.prototype.deop=function(e,t,n,r){return this.client.deop(this.name,e,t,n,r)};t.prototype.modifyAffiliation=function(e,t,n,r,i){return this.client.modifyAffiliation(this.name,e,t,n,r,i)};t.prototype.ban=function(e,t,n,r){return this.client.ban(this.name,e,t,n,r)};t.prototype.member=function(e,t,n,r){return this.client.member(this.name,e,t,n,r)};t.prototype.revoke=function(e,t,n,r){return this.client.revoke(this.name,e,t,n,r)};t.prototype.owner=function(e,t,n,r){return this.client.owner(this.name,e,t,n,r)};t.prototype.admin=function(e,t,n,r){return this.client.admin(this.name,e,t,n,r)};t.prototype.changeNick=function(e){this.nick=e;return this.client.changeNick(this.name,e)};t.prototype.setStatus=function(e,t){return this.client.setStatus(this.name,this.nick,e,t)};t.prototype.addHandler=function(e,t){var n;n=this._handler_ids++;switch(e){case"presence":this._presence_handlers[n]=t;break;case"message":this._message_handlers[n]=t;break;case"roster":this._roster_handlers[n]=t;break;default:this._handler_ids--;return null}return n};t.prototype.removeHandler=function(e){delete this._presence_handlers[e];delete this._message_handlers[e];return delete this._roster_handlers[e]};t.prototype._addOccupant=function(t){var n;n=new e(t,this);this.roster[n.nick]=n;return n};t.prototype._roomRosterHandler=function(e){var n,r,i,s,o,u;n=t._parsePresence(e);o=n.nick;s=n.newnick||null;switch(n.type){case"error":return;case"unavailable":if(s){n.nick=s;if(this.roster[o]&&this.roster[s]){this.roster[o].update(this.roster[s]);this.roster[s]=this.roster[o]}if(this.roster[o]&&!this.roster[s]){this.roster[s]=this.roster[o].update(n)}}delete this.roster[o];break;default:if(this.roster[o]){this.roster[o].update(n)}else{this._addOccupant(n)}}u=this._roster_handlers;for(i in u){r=u[i];if(!r(this.roster,this)){delete this._roster_handlers[i]}}return true};t._parsePresence=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;i={};t=e.attributes;i.nick=Strophe.getResourceFromJid(t.from.textContent);i.type=((f=t.type)!=null?f.textContent:void 0)||null;i.states=[];l=e.childNodes;for(s=0,u=l.length;s<u;s++){n=l[s];switch(n.nodeName){case"status":i.status=n.textContent||null;break;case"show":i.show=n.textContent||null;break;case"x":t=n.attributes;if(((c=t.xmlns)!=null?c.textContent:void 0)===Strophe.NS.MUC_USER){h=n.childNodes;for(o=0,a=h.length;o<a;o++){r=h[o];switch(r.nodeName){case"item":t=r.attributes;i.affiliation=((p=t.affiliation)!=null?p.textContent:void 0)||null;i.role=((d=t.role)!=null?d.textContent:void 0)||null;i.jid=((v=t.jid)!=null?v.textContent:void 0)||null;i.newnick=((m=t.nick)!=null?m.textContent:void 0)||null;break;case"status":if(r.attributes.code){i.states.push(r.attributes.code.textContent)}}}}}}return i};return t}();t=function(){function e(e){this.parse=r(this.parse,this);if(e!=null){this.parse(e)}}e.prototype.parse=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;o=e.getElementsByTagName("query")[0].childNodes;this.identities=[];this.features=[];this.x=[];for(u=0,l=o.length;u<l;u++){r=o[u];n=r.attributes;switch(r.nodeName){case"identity":s={};for(a=0,c=n.length;a<c;a++){t=n[a];s[t.name]=t.textContent}this.identities.push(s);break;case"feature":this.features.push(n["var"].textContent);break;case"x":n=r.childNodes[0].attributes;if(!n["var"].textContent==="FORM_TYPE"||!n.type.textContent==="hidden"){break}p=r.childNodes;for(f=0,h=p.length;f<h;f++){i=p[f];if(!!i.attributes.type){continue}n=i.attributes;this.x.push({"var":n["var"].textContent,label:n.label.textContent||"",value:i.firstChild.textContent||""})}}}return{identities:this.identities,features:this.features,x:this.x}};return e}();e=function(){function e(e,t){this.room=t;this.update=r(this.update,this);this.admin=r(this.admin,this);this.owner=r(this.owner,this);this.revoke=r(this.revoke,this);this.member=r(this.member,this);this.ban=r(this.ban,this);this.modifyAffiliation=r(this.modifyAffiliation,this);this.deop=r(this.deop,this);this.op=r(this.op,this);this.mute=r(this.mute,this);this.voice=r(this.voice,this);this.kick=r(this.kick,this);this.modifyRole=r(this.modifyRole,this);this.update(e)}e.prototype.modifyRole=function(e,t,n,r){return this.room.modifyRole(this.nick,e,t,n,r)};e.prototype.kick=function(e,t,n){return this.room.kick(this.nick,e,t,n)};e.prototype.voice=function(e,t,n){return this.room.voice(this.nick,e,t,n)};e.prototype.mute=function(e,t,n){return this.room.mute(this.nick,e,t,n)};e.prototype.op=function(e,t,n){return this.room.op(this.nick,e,t,n)};e.prototype.deop=function(e,t,n){return this.room.deop(this.nick,e,t,n)};e.prototype.modifyAffiliation=function(e,t,n,r){return this.room.modifyAffiliation(this.jid,e,t,n,r)};e.prototype.ban=function(e,t,n){return this.room.ban(this.jid,e,t,n)};e.prototype.member=function(e,t,n){return this.room.member(this.jid,e,t,n)};e.prototype.revoke=function(e,t,n){return this.room.revoke(this.jid,e,t,n)};e.prototype.owner=function(e,t,n){return this.room.owner(this.jid,e,t,n)};e.prototype.admin=function(e,t,n){return this.room.admin(this.jid,e,t,n)};e.prototype.update=function(e){this.nick=e.nick||null;this.affiliation=e.affiliation||null;this.role=e.role||null;this.jid=e.jid||null;this.status=e.status||null;this.show=e.show||null;return this};return e}()}).call(this)