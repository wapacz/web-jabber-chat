(function(e){var t={options:{bosh_service:"http-bind/",domain:"",resource:"sharpchat",dataUrl:"data/json.php",onSuccess:null,onError:null},container:null,connection:null,user:null,contacts:[],selectedContacts:[],success_cb:null,error_cb:null,init:function(e){t.container=this;t.container.addClass("chat-container");t.container.append(t.createMainGui());t.minimize();t.connection=new Strophe.Connection(t.options.bosh_service);t.connection.muc.init(t.connection);t.success_cb=t.options.onSuccess;t.error_cb=t.options.onError},log:function(t){var n=e("#log");n.append("<div>").append(document.createTextNode(t));n.scrollTop(n[0].scrollHeight-n.height())},rawInput:function(e){t.log("IN >>> "+e)},rawOutput:function(e){t.log("OUT <<< "+e)},login:function(e){t.user={jid:t.options.login+"@"+t.options.domain,full_jid:t.options.login+"@"+t.options.domain+"/"+t.options.resource,username:t.options.login,password:t.options.password};t.connection.connect(t.user.full_jid,t.user.password,t.onConnect)},logout:function(){t.connection.disconnect()},onConnect:function(n){switch(n){case Strophe.Status.CONNECTING:case Strophe.Status.AUTHENTICATING:t.headerText.html("Logowanie...");t.userIcon.addClass("chat-list-user-notactive");t.userIcon.removeClass("chat-list-user-active");break;case Strophe.Status.CONNECTED:case Strophe.Status.ATTACHED:t.success_cb("Zalogowano do chata");t.headerText.html("Zalogowany <strong>"+t.user.username+"</strong>");t.userIcon.removeClass("chat-list-user-notactive");t.userIcon.addClass("chat-list-user-active");t.clearUserList();e.ajax({dataType:"json",url:t.options.dataUrl,data:{action:"get",contacts:t.user.username},success:function(e){t.onUsersFetched(e)}});t.connection.addHandler(t.onPresenceSubscriptionRequest,null,"presence","subscribe");t.connection.addHandler(t.onPresence,null,"presence");t.connection.addHandler(t.onMessage,null,"message",null,null,null);t.connection.addHandler(t.onConferenceRequest,"jabber:x:conference","message",null,null,null);t.connection.send($pres().tree());break;break;case Strophe.Status.CONNFAIL:case Strophe.Status.AUTHFAIL:t.error_cb("Wystąpił problem z logowaniem do chata");case Strophe.Status.DISCONNECTING:case Strophe.Status.DISCONNECTED:default:t.headerText.html("Niedostępny");t.userIcon.addClass("chat-list-user-notactive");t.userIcon.removeClass("chat-list-user-active");t.clearUserList();for(var r=0;r<t.chatBoxes.length;r++){var i=t.chatBoxes[r];i.Minimize();i.Get$().hide()}break}},onUsersFetched:function(n){t.contacts=e(n).sort(function(e,t){return e.username.toLowerCase()>t.username.toLowerCase()?1:-1});t.contacts.each(function(){var n=this;if(n.username!=t.user.username){t.list.append(e("<li>").attr({id:n.username}).data("userCredentials",{username:n.username,jid:n.username+"@"+t.options.domain+"/"+t.options.resource}).data("presence","unavailable").css({height:"24px"}).addClass("chat-list-userlist-element ui-corner-all").append(e("<div>").attr({id:"icon"}).addClass("chat-list-user-notactive")).append(e("<div>").addClass("chat-list-userlist-text").text(n.username)).append(e("<div>").attr({id:"private-chat-icon",title:"Prywatny chat"}).css({"float":"right",height:"17px",width:"17px","margin-right":"3px"}).addClass("chat-list-icon ui-corner-all").append(e("<span>").addClass("ui-icon ui-icon-comment")).hide().click(function(){t.contextMenu.hide();var n=e(this).parent().data("userCredentials");t.showChatBox(n.jid,n.username,"chat")})).bind("mouseover",function(){e(this).find("#private-chat-icon").show()}).bind("mouseout",function(){e(this).find("#private-chat-icon").hide()}).bind("click",function(){t.contextMenu.hide()}).bind("dblclick",function(){var n=e(this).data("userCredentials");t.showChatBox(n.jid,n.username,"chat")}).bind("contextmenu",function(n){t.contextMenu.data("selectedUser",e(this).data("userCredentials"));t.contextMenu.css({left:n.pageX,top:n.pageY,zIndex:"101"}).show();return false}));t.connection.send($pres({to:n.username+"@"+t.options.domain,type:"subscribe"}))}})},clearUserList:function(){t.list.children().each(function(){e(this).remove()})},onMessage:function(e){var n=e.getAttribute("to");var r=e.getAttribute("from");var i=e.getAttribute("type");var s=e.getElementsByTagName("body");if(s.length>0){var o=s[0];if(i=="chat"||i=="normal"){var u=r;var a=Strophe.getNodeFromJid(r);var f=Strophe.getText(o);var l=t._getChatBox(u,a,"chat");l.UpdateChat(u,a,f);l.Maximize()}else if(i=="groupchat"){var u=Strophe.getBareJidFromJid(r);var a=Strophe.getResourceFromJid(r);if(a!=null){var f=Strophe.getText(o);var l=t._getChatBox(u,"Rozmowa grupowa","groupchat");l.UpdateChat(u,a,f);l.Maximize()}}}return true},onPresenceSubscriptionRequest:function(e){var n=e.getAttribute("from");t.connection.send($pres({to:Strophe.getBareJidFromJid(n),type:"subscribed"}));return true},onPresence:function(n){var r=n.getAttribute("to");var i=n.getAttribute("from");var s=n.getAttribute("type");var o=Strophe.getBareJidFromJid(i);var u=Strophe.getNodeFromJid(i);var a=e("li#"+u);var f=a.find("div#icon");if(s=="unavailable"){a.data("presence","unavailable");f.addClass("chat-list-user-notactive");f.removeClass("chat-list-user-active")}else{a.data("presence","available");f.addClass("chat-list-user-active");f.removeClass("chat-list-user-notactive")}for(var l=0;l<t.chatBoxes.length;l++){var c=t.chatBoxes[l];c.updatePresence()}return true},onConferenceRequest:function(e){var n=e.getElementsByTagName("x");if(n.length>1){var r=n[1];var i=Strophe.getBareJidFromJid(r.getAttribute("jid"));t.connection.muc.join(i,t.user.username)}return true},showChatBox:function(e,n,r){if(!t.connection.connected)return;if(!t.connection.authenticated)return;var i=t._getChatBox(e,n,r);i.Maximize()},sendMessage:function(e,n,r){if(t.connection.connected&&t.connection.authenticated){if(r.length>0){var i=$msg({to:e,from:t.connection.jid,type:n}).c("body").t(r);t.connection.send(i.tree())}}else{}},_findChatBoxByJid:function(e){for(var n=0;n<t.chatBoxes.length;n++){var r=t.chatBoxes[n];if(r.jid==e){return r}}return null},_getChatBox:function(e,r,i){var s=t._findChatBoxByJid(e);if(s==null){var s=new n(e,r,i);t.chatBoxes.push(s);t.container.append(s.Get$())}return s},isMinimized:false,chatBoxes:[],listContainer:null,header:null,main:null,footer:null,list:null,userIcon:null,minimizeBox:null,maximizeBox:null,loginBox:null,contextMenu:null,createMainGui:function(){var n=e("<div>").addClass("chat-list");var r=e("<div>").addClass("chat-list-header").dblclick(function(){if(t.isMinimized)t.maximize();else t.minimize()});var i=e("<div>").addClass("chat-list-main");var s=e("<div>").addClass("chat-list-footer");n.append(r);n.append(i);n.append(s);var o=e("<div>").addClass("chat-list-user-notactive");r.append(o);var u=e("<div>").addClass("chat-list-header-text").html("Niedostępny");r.append(u);var a=e("<div>").addClass("chat-list-header-icons");var f=e("<div>").addClass("chat-list-icon ui-corner-all").append(e("<span>").addClass("ui-icon ui-icon-triangle-1-s")).attr({title:"Minimalizuj"}).click(function(){t.minimize()});a.append(f);var l=e("<div>").addClass("chat-list-icon ui-corner-all").append(e("<span>").addClass("ui-icon ui-icon-triangle-1-n")).attr({title:"Pokaż czat"}).hide().click(function(){t.maximize()});a.append(l);var c=e("<div>").addClass("chat-list-icon ui-corner-all").append(e("<span>").addClass("ui-icon ui-icon ui-icon-power")).attr({title:"Wyloguj"}).click(function(){if(t.connection.connected){t.logout();c.attr({title:"Zaloguj"})}else{t.login();c.attr({title:"Wyloguj"})}});a.append(c);r.append(a);var h=e("<ol>").addClass("chat-list-userlist").selectable({stop:function(){t.selectedContacts=[];e(".ui-selected",this).each(function(){var n=e("#selectable li").index(this);t.selectedContacts.push(e(this).data("userCredentials"))})},cancel:"span"});i.append(h);t.contextMenu=t.createContextMenu();t.listContainer=n;t.header=r;t.main=i;t.footer=s;t.userIcon=o;t.headerText=u;t.minimizeBox=f;t.maximizeBox=l;t.loginBox=c;t.list=h;return n},createContextMenu:function(){var n=e("<ul>").hide().append(e("<li>").append(e("<a>").attr({href:"#"}).text("Prywatny chat").append(e("<span>").addClass("ui-icon ui-icon-person"))).click(function(){n.hide();t.showChatBox(n.data("selectedUser").jid,n.data("selectedUser").username,"chat")}).bind("contextmenu",function(){n.hide();return false})).append(e("<li>").append(e("<a>").attr({href:"#"}).text("Rozmowa grupowa").append(e("<span>").addClass("ui-icon ui-icon-comment"))).click(function(){n.hide();var e="conference"+Math.floor(Math.random()*1e4+1)+"@conference."+Strophe.getDomainFromJid(t.user.jid);t.connection.muc.join(e,t.user.username,function(n){var r=new Array;r.push("field");t.connection.muc.configure(e,function(n){t.connection.muc.saveConfiguration(e,n,function(){for(var n=0;n<t.selectedContacts.length;n++){t.connection.muc.invite(e,t.selectedContacts[n].jid,null)}})})});t.showChatBox(e,"Rozmowa grupowa","groupchat")}).bind("contextmenu",function(){n.hide();return false})).css({left:"0px",top:"0px",position:"absolute",width:"150px"}).appendTo(document.body).menu();return n},minimize:function(){t.maximizeBox.show();t.minimizeBox.hide();t.footer.hide();t.main.hide();t.listContainer.removeClass("chat-list-maximized");t.listContainer.addClass("chat-list-minimized");t.isMinimized=true},maximize:function(){t.maximizeBox.hide();t.minimizeBox.show();t.footer.show();t.main.show();t.listContainer.removeClass("chat-list-minimized");t.listContainer.addClass("chat-list-maximized");t.isMinimized=false}};var n=function(t,n,r){var i=this;i.jid=t;i.username=n;i.type=r;i.isMinimized=false;i.chatBox=e("<div>").addClass("chat-box");i.chatBoxHeader=e("<div>").addClass("chat-box-header").dblclick(function(){if(i.isMinimized)i.Maximize();else i.Minimize()});i.chatBoxMain=e("<div>").addClass("chat-box-main");i.chatBoxFooter=e("<div>").addClass("chat-box-footer");i.chatBox.append(i.chatBoxHeader);i.chatBox.append(i.chatBoxMain);i.chatBox.append(i.chatBoxFooter);i.chatBoxHeader.append(e("<div>").addClass("chat-box-header-text").html("<strong>"+i.username+"</strong>"));i.chatBoxTextArea=e("<div>").addClass("chat-box-textarea");i.chatBoxMain.append(i.chatBoxTextArea);i.chatBoxWarning=e("<div>").addClass("chat-box-warning").hide();i.chatBoxWarningText=e("<div>").addClass("chat-box-warning-text");i.chatBoxWarning.append(i.chatBoxWarningText);i.chatBoxMain.append(i.chatBoxWarning);i.chatBoxInput=e("<input>").addClass("chat-box-input").attr({type:"text"}).bind("keypress",function(e){var t=e.keyCode?e.keyCode:e.which;var n=i.chatBoxInput.val();if(t==13&&n!=""){e.stopPropagation();i.Send(n)}});i.chatBoxFooter.append(i.chatBoxInput);var s=e("<div>").addClass("chat-box-icon ui-corner-all chat-box-sendbutton").append(e("<span>").addClass("ui-icon ui-icon-comment")).attr({title:"Wyślij"}).click(function(){var e=i.chatBoxInput.val();if(e!=""){i.Send(e)}});i.chatBoxFooter.append(s);var o=e("<div>").addClass("chat-box-header-icons");i.minimizeBox=e("<div>").addClass("chat-box-icon ui-corner-all").append(e("<span>").addClass("ui-icon ui-icon-triangle-1-s")).attr({title:"Minimalizuj"}).click(function(){i.Minimize()});o.append(i.minimizeBox);i.maximizeBox=e("<div>").addClass("chat-box-icon ui-corner-all").append(e("<span>").addClass("ui-icon ui-icon-triangle-1-n")).attr({title:"Pokaż czat"}).hide().click(function(){i.Maximize()});o.append(i.maximizeBox);i.closeBox=e("<div>").addClass("chat-box-icon ui-corner-all").append(e("<span>").addClass("ui-icon ui-icon-closethick")).attr({title:"Zamknij czat"}).click(function(){i.Destroy()});o.append(i.closeBox);i.chatBoxHeader.append(o);i.chatBoxInput.focus()};n.prototype.Get$=function(){return this.chatBox};n.prototype.Minimize=function(){var e=this;e.maximizeBox.show();e.minimizeBox.hide();e.chatBoxFooter.hide();e.chatBoxMain.hide();e.chatBox.removeClass("chat-box-maximized");e.chatBox.addClass("chat-box-minimized");e.isMinimized=true};n.prototype.Maximize=function(){var e=this;e.updatePresence();e.maximizeBox.hide();e.minimizeBox.show();e.chatBoxFooter.show();e.chatBoxMain.show();e.chatBox.removeClass("chat-box-minimized");e.chatBox.addClass("chat-box-maximized");e.chatBox.show();e.chatBoxInput.focus();e.isMinimized=false};n.prototype.Destroy=function(){var e=this;e.chatBox.hide();if(e.type=="groupchat"){t.connection.muc.leave(e.jid,t.user.username);delete e.isMinimized;delete e.chatBox;delete e.chatBoxMain;delete e.chatBoxFooter;delete e.chatBoxHeader;delete e.chatBoxInput;delete e.minimizeBox;delete e.maximizeBox;delete e.closeBox;delete e.chatBox;delete e}};n.prototype.Warning=function(e,t){var n=this;if(e=="show"){n.chatBoxTextArea.addClass("chat-box-textarea-warning");n.chatBoxTextArea.removeClass("chat-box-textarea");n.chatBoxWarningText.html(t);n.chatBoxWarning.show()}else if(e=="hide"){n.chatBoxTextArea.addClass("chat-box-textarea");n.chatBoxTextArea.removeClass("chat-box-textarea-warning");n.chatBoxWarning.hide()}else{}n.chatBoxTextArea.scrollTop(n.chatBoxTextArea[0].scrollHeight-n.chatBoxTextArea.height())};n.prototype.Send=function(e){var n=this;if(n.type=="chat"){t.sendMessage(n.jid,"chat",e);var r="";if(n.lastWriter!=t.user.username){var i=new Date;var s=i.getHours();var o=i.getMinutes();if(o<10)o="0"+o;var u=i.getSeconds();if(u<10)u="0"+u;r="<span style='color: gray; font-size: 90%; float: right;'>"+s+":"+o+":"+u+"</span> "+"<span style='color: gray; font-size: 90%;'>"+t.user.username+"</span>"}n.chatBoxTextArea.append(r+"<div style='padding-left: 10px; padding-bottom: 3px;'>"+e+"</div>");n.chatBoxTextArea.scrollTop(n.chatBoxTextArea[0].scrollHeight-n.chatBoxTextArea.height());n.lastWriter=t.user.username}else{var a=Strophe.getBareJidFromJid(n.jid);t.sendMessage(a,"groupchat",e)}n.chatBoxInput.val("");n.chatBoxInput.focus()};n.prototype.updatePresence=function(){var t=this;if(t.type=="chat"){var n=e("li#"+t.username).data("presence");if(n=="unavailable"){t.Warning("show","Użytkownik <strong>"+t.username+"</strong> nie jest dostępny. Te wiadomości dotrą do niego dopiero gdy będzie zalogowany.")}else{t.Warning("hide")}}};n.prototype.onMessage=function(e,t,n){var r=this;r.UpdateChat(e,t,n);r.Maximize()};n.prototype.UpdateChat=function(e,t,n){var r=this;var i="";if(r.lastWriter!=t){var s=new Date;var o=s.getHours();var u=s.getMinutes();if(u<10)u="0"+u;var a=s.getSeconds();if(a<10)a="0"+a;i="<span style='color: gray; font-size: 90%; float: right;'>"+o+":"+u+":"+a+"</span> "+"<span style='color: gray; font-size: 90%;'>"+t+"</span>"}r.chatBoxTextArea.append(i+"<div style='padding-left: 10px; padding-bottom: 3px;'>"+n+"</div>");r.chatBoxTextArea.scrollTop(r.chatBoxTextArea[0].scrollHeight-r.chatBoxTextArea.height());r.lastWriter=t};e.fn.chat=function(n,r){t.options=e.extend(t.options,r);if(t[n]){return t[n].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof n==="object"||!n){return t.init.apply(this,arguments)}else{e.error("Method "+n+" does not exist in jQuery.chat")}}})(jQuery)